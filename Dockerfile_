# Stage: build
FROM node:20-alpine as build

ARG NEXT_PUBLIC_URL
ARG NEXT_PUBLIC_AUTO_VERIFICATION
ARG NEXT_PUBLIC_WEB_SOCKET
ARG NEXT_PUBLIC_DOMAIN
ARG NEXT_PUBLIC_API_KEY_YANDEX

ENV NEXT_PUBLIC_URL=$NEXT_PUBLIC_URL
ENV NEXT_PUBLIC_AUTO_VERIFICATION=$NEXT_PUBLIC_AUTO_VERIFICATION
ENV NEXT_PUBLIC_WEB_SOCKET=$NEXT_PUBLIC_WEB_SOCKET
ENV NEXT_PUBLIC_DOMAIN=$NEXT_PUBLIC_DOMAIN
ENV NEXT_PUBLIC_API_KEY_YANDEX=$NEXT_PUBLIC_API_KEY_YANDEX

WORKDIR /app

# Authorize in npm then install dependencies
COPY package.json package-lock.json ./
RUN npm install

# 1. Build app
# 2. Prune dev dependencies
# 3. Delete sources we don't need anymore
COPY . ./

RUN npm build && rm -rf src && rm -rf .next/cache && npm prune --prod

# Stage: run
FROM node:20-alpine

WORKDIR /app

COPY --from=build /app ./


ARG NEXT_PUBLIC_URL
ARG NEXT_PUBLIC_AUTO_VERIFICATION
ARG NEXT_PUBLIC_WEB_SOCKET
ARG NEXT_PUBLIC_DOMAIN
ARG NEXT_PUBLIC_API_KEY_YANDEX

ENV NEXT_PUBLIC_URL=$NEXT_PUBLIC_URL
ENV NEXT_PUBLIC_AUTO_VERIFICATION=$NEXT_PUBLIC_AUTO_VERIFICATION
ENV NEXT_PUBLIC_WEB_SOCKET=$NEXT_PUBLIC_WEB_SOCKET
ENV NEXT_PUBLIC_DOMAIN=$NEXT_PUBLIC_DOMAIN
ENV NEXT_PUBLIC_API_KEY_YANDEX=$NEXT_PUBLIC_API_KEY_YANDEX

CMD ["npm", "start"]
